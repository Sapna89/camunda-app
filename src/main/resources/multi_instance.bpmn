<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bioc="http://bpmn.io/schema/bpmn/biocolor/1.0" xmlns:color="http://www.omg.org/spec/BPMN/non-normative/color/1.0" xmlns:modeler="http://camunda.org/schema/modeler/1.0" id="Definitions_13qog9w" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="4.12.0" modeler:executionPlatform="Camunda Platform" modeler:executionPlatformVersion="7.15.0">
  <bpmn:process id="multi_instance_execute" name="Multi Instance " isExecutable="true">
    <bpmn:startEvent id="StartEvent_1">
      <bpmn:outgoing>Flow_1r3rcpi</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:sequenceFlow id="Flow_1r3rcpi" sourceRef="StartEvent_1" targetRef="Activity_0hi4moh" />
    <bpmn:serviceTask id="Activity_0hi4moh" name="Initialize Subject List" camunda:class="com.workflow.delegates.NewSubjectsInitialize">
      <bpmn:extensionElements>
        <camunda:inputOutput>
          <camunda:outputParameter name="errors">
            <camunda:script scriptFormat="Javascript">var errors = [];
errors;</camunda:script>
          </camunda:outputParameter>
          <camunda:outputParameter name="temp">
            <camunda:script scriptFormat="JavaScript">print('Initialize Subject List :: ' + subjectList);
</camunda:script>
          </camunda:outputParameter>
        </camunda:inputOutput>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1r3rcpi</bpmn:incoming>
      <bpmn:outgoing>Flow_0th89ys</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="Flow_0th89ys" sourceRef="Activity_0hi4moh" targetRef="Activity_0t1oy8v" />
    <bpmn:scriptTask id="Activity_0t1oy8v" name="Assign Subject Name" scriptFormat="JavaScript">
      <bpmn:incoming>Flow_0th89ys</bpmn:incoming>
      <bpmn:outgoing>Flow_19wu9ct</bpmn:outgoing>
      <bpmn:multiInstanceLoopCharacteristics isSequential="true" camunda:collection="${subjectList}" camunda:elementVariable="subjectObj">
        <bpmn:loopCardinality xsi:type="bpmn:tFormalExpression">${subjectList.size()}</bpmn:loopCardinality>
      </bpmn:multiInstanceLoopCharacteristics>
      <bpmn:script>print('subjectObj id :: ' + subjectObj.get('id'));

var id = subjectObj.get('id');

if(id == 1) { subjectObj.put('name' , 'English') ; }
else if(id == 2) { subjectObj.put('name' , 'Mathematics') ; }
else if(id == 3) { subjectObj.put('name' , 'Science') ; }
else if(id == 4) { subjectObj.put('name' , 'Social Studies') ; }

</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:sequenceFlow id="Flow_19wu9ct" sourceRef="Activity_0t1oy8v" targetRef="Activity_11bwoyc" />
    <bpmn:scriptTask id="Activity_11bwoyc" name="Print Subject List after assigning Name" scriptFormat="JavaScript">
      <bpmn:incoming>Flow_19wu9ct</bpmn:incoming>
      <bpmn:outgoing>Flow_14ccc4f</bpmn:outgoing>
      <bpmn:script>print('Subject List after assigning Name :: ' + subjectList);</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:sequenceFlow id="Flow_14ccc4f" sourceRef="Activity_11bwoyc" targetRef="Activity_0gup0i2" />
    <bpmn:serviceTask id="Activity_0gup0i2" name="Assign Display Name" camunda:delegateExpression="${subjectDisplayNameAssign}">
      <bpmn:incoming>Flow_14ccc4f</bpmn:incoming>
      <bpmn:outgoing>Flow_0ahn1ww</bpmn:outgoing>
      <bpmn:multiInstanceLoopCharacteristics camunda:collection="${subjectList}" camunda:elementVariable="subjectObj">
        <bpmn:loopCardinality xsi:type="bpmn:tFormalExpression">${subjectList.size()}</bpmn:loopCardinality>
      </bpmn:multiInstanceLoopCharacteristics>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="Flow_0ahn1ww" sourceRef="Activity_0gup0i2" targetRef="Activity_1xrl53c" />
    <bpmn:scriptTask id="Activity_1xrl53c" name="Print Subject List after Assigning display name" scriptFormat="JavaScript">
      <bpmn:incoming>Flow_0ahn1ww</bpmn:incoming>
      <bpmn:outgoing>Flow_0j6jobe</bpmn:outgoing>
      <bpmn:script>print('Subject List after Assigning display name :: ' + subjectList);</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:sequenceFlow id="Flow_0j6jobe" sourceRef="Activity_1xrl53c" targetRef="Activity_1hynd0y" />
    <bpmn:scriptTask id="Activity_1hynd0y" name="Convert Java List into JSON" scriptFormat="JavaScript" camunda:resultVariable="subjectArray">
      <bpmn:incoming>Flow_0j6jobe</bpmn:incoming>
      <bpmn:outgoing>Flow_1f2x99w</bpmn:outgoing>
      <bpmn:script>var subjectArray = [];

for(var i = 0; i &lt; subjectList.size(); i++) {
var subjectObj = {}; //doing this: is creating a JSON object

var subjectMap = subjectList.get(i);

subjectObj.id = subjectMap.get('id');
subjectObj.name = subjectMap.get('name');
subjectObj.displayName = subjectMap.get('displayName');


subjectArray.push(subjectObj);
}

print("subjectArray JSON :: " + JSON.stringify(subjectArray));

subjectArray;</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:sequenceFlow id="Flow_1f2x99w" sourceRef="Activity_1hynd0y" targetRef="Activity_05x7br4" />
    <bpmn:scriptTask id="Activity_05x7br4" name="Convert JSON into JSON Node" scriptFormat="JavaScript" camunda:resultVariable="subjectListJSONNode">
      <bpmn:incoming>Flow_1f2x99w</bpmn:incoming>
      <bpmn:outgoing>Flow_15odkbo</bpmn:outgoing>
      <bpmn:script>S(JSON.stringify(subjectArray));</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:sequenceFlow id="Flow_15odkbo" sourceRef="Activity_05x7br4" targetRef="Activity_1ib3xgy" />
    <bpmn:subProcess id="Activity_1ib3xgy">
      <bpmn:incoming>Flow_15odkbo</bpmn:incoming>
      <bpmn:outgoing>Flow_0rmrkjr</bpmn:outgoing>
      <bpmn:multiInstanceLoopCharacteristics isSequential="true" camunda:collection="${subjectListJSONNode.elements()}" camunda:elementVariable="subjectObj">
        <bpmn:loopCardinality xsi:type="bpmn:tFormalExpression">${subjectListJSONNode.elements().size()}</bpmn:loopCardinality>
      </bpmn:multiInstanceLoopCharacteristics>
      <bpmn:startEvent id="Event_1fh60qp">
        <bpmn:outgoing>Flow_1e7cr15</bpmn:outgoing>
      </bpmn:startEvent>
      <bpmn:sequenceFlow id="Flow_1e7cr15" sourceRef="Event_1fh60qp" targetRef="Activity_00g7hqv" />
      <bpmn:sequenceFlow id="Flow_0t65618" sourceRef="Activity_00g7hqv" targetRef="Activity_1fx4oho" />
      <bpmn:endEvent id="Event_0utj1vy">
        <bpmn:incoming>Flow_1gjhsst</bpmn:incoming>
      </bpmn:endEvent>
      <bpmn:sequenceFlow id="Flow_1gjhsst" sourceRef="Activity_1fx4oho" targetRef="Event_0utj1vy" />
      <bpmn:scriptTask id="Activity_00g7hqv" name="Assign Subject Code" scriptFormat="JavaScript">
        <bpmn:incoming>Flow_1e7cr15</bpmn:incoming>
        <bpmn:outgoing>Flow_0t65618</bpmn:outgoing>
        <bpmn:script>print("whats in the subjectObj :: " + subjectObj);

var subjectName = subjectObj.prop('name').value();

var subjectCode = '';

if (subjectName == 'English'){ subjectCode = 'E59'; }

else if (subjectName == 'Mathematics'){ subjectCode = 'M21'; }

else if (subjectName == 'Science'){ subjectCode = 'S15'; }

subjectObj.prop('code', subjectCode);
</bpmn:script>
      </bpmn:scriptTask>
      <bpmn:scriptTask id="Activity_1fx4oho" name="Assign Subject Teacher Info" scriptFormat="JavaScript">
        <bpmn:incoming>Flow_0t65618</bpmn:incoming>
        <bpmn:outgoing>Flow_1gjhsst</bpmn:outgoing>
        <bpmn:script>print("whats in the subjectObj :: " + subjectObj);

var subjectName = subjectObj.prop('name').value();

var subjectTeacherId = '';
var subjectTeacherName = '';

switch(subjectName) {
case 'English': subjectTeacherId = '';
subjectTeacherName = '';
break;

case 'Mathematics': subjectTeacherId = 101;
subjectTeacherName = 'John';
break;

case 'Science': subjectTeacherId = 102;
subjectTeacherName = 'Chris';
break;

case 'Social Studies': subjectTeacherId = 103;
subjectTeacherName = 'Ria';
break;

}

subjectObj.prop('subjectTeacherId', subjectTeacherId);
subjectObj.prop('subjectTeacherName', subjectTeacherName);
</bpmn:script>
      </bpmn:scriptTask>
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="Flow_0rmrkjr" sourceRef="Activity_1ib3xgy" targetRef="Activity_0kwwiy2" />
    <bpmn:scriptTask id="Activity_0kwwiy2" name="Print SubjectList After Assigning TeacherId and Name" scriptFormat="JavaScript">
      <bpmn:incoming>Flow_0rmrkjr</bpmn:incoming>
      <bpmn:outgoing>Flow_0idq6f9</bpmn:outgoing>
      <bpmn:script>print("subjectList after assigning subject code and teacher info :: " + subjectListJSONNode);

</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:sequenceFlow id="Flow_0idq6f9" sourceRef="Activity_0kwwiy2" targetRef="Activity_1qrx4i9" />
    <bpmn:subProcess id="Activity_1qrx4i9">
      <bpmn:incoming>Flow_0idq6f9</bpmn:incoming>
      <bpmn:outgoing>Flow_1vhnmwh</bpmn:outgoing>
      <bpmn:multiInstanceLoopCharacteristics isSequential="true" camunda:collection="${subjectListJSONNode.elements()}" camunda:elementVariable="subjectObj">
        <bpmn:loopCardinality xsi:type="bpmn:tFormalExpression">${subjectListJSONNode.elements().size()}</bpmn:loopCardinality>
      </bpmn:multiInstanceLoopCharacteristics>
      <bpmn:startEvent id="Event_1kldzbt">
        <bpmn:outgoing>Flow_1py6j9x</bpmn:outgoing>
      </bpmn:startEvent>
      <bpmn:businessRuleTask id="Activity_1ihxtce" name="Validate Missing Info" camunda:resultVariable="errorList" camunda:decisionRef="subject_validation_multi_instance_dmn">
        <bpmn:extensionElements>
          <camunda:inputOutput>
            <camunda:outputParameter name="temp">
              <camunda:script scriptFormat="JavaScript">print("ErrorListDMN :: " + errorList);

for(var i=0; i &lt; errorList.size(); i++) {
 var obj = {};
 var errorMap = errorList.get(i);

 obj.errorMessage = errorMap.get('errorMessage');
 obj.field = errorMap.get('field');
 obj.subjectId = errorMap.get('subjectId');

 errors.push(obj);
}</camunda:script>
            </camunda:outputParameter>
          </camunda:inputOutput>
        </bpmn:extensionElements>
        <bpmn:incoming>Flow_1py6j9x</bpmn:incoming>
        <bpmn:outgoing>Flow_152dq6y</bpmn:outgoing>
      </bpmn:businessRuleTask>
      <bpmn:sequenceFlow id="Flow_1py6j9x" sourceRef="Event_1kldzbt" targetRef="Activity_1ihxtce" />
      <bpmn:endEvent id="Event_11keq65">
        <bpmn:incoming>Flow_152dq6y</bpmn:incoming>
      </bpmn:endEvent>
      <bpmn:sequenceFlow id="Flow_152dq6y" sourceRef="Activity_1ihxtce" targetRef="Event_11keq65" />
    </bpmn:subProcess>
    <bpmn:sequenceFlow id="Flow_1vhnmwh" sourceRef="Activity_1qrx4i9" targetRef="Activity_015hhqx" />
    <bpmn:scriptTask id="Activity_015hhqx" name="print" scriptFormat="JavaScript">
      <bpmn:incoming>Flow_1vhnmwh</bpmn:incoming>
      <bpmn:script>print("Final Errors :: " + JSON.stringify(errors));</bpmn:script>
    </bpmn:scriptTask>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="multi_instance_execute">
      <bpmndi:BPMNEdge id="Flow_0idq6f9_di" bpmnElement="Flow_0idq6f9">
        <di:waypoint x="2130" y="187" />
        <di:waypoint x="2230" y="187" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0rmrkjr_di" bpmnElement="Flow_0rmrkjr">
        <di:waypoint x="1950" y="187" />
        <di:waypoint x="2030" y="187" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_15odkbo_di" bpmnElement="Flow_15odkbo">
        <di:waypoint x="1330" y="187" />
        <di:waypoint x="1410" y="187" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1f2x99w_di" bpmnElement="Flow_1f2x99w">
        <di:waypoint x="1170" y="187" />
        <di:waypoint x="1230" y="187" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0j6jobe_di" bpmnElement="Flow_0j6jobe">
        <di:waypoint x="1010" y="187" />
        <di:waypoint x="1070" y="187" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0ahn1ww_di" bpmnElement="Flow_0ahn1ww">
        <di:waypoint x="850" y="187" />
        <di:waypoint x="910" y="187" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_14ccc4f_di" bpmnElement="Flow_14ccc4f">
        <di:waypoint x="690" y="187" />
        <di:waypoint x="750" y="187" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_19wu9ct_di" bpmnElement="Flow_19wu9ct">
        <di:waypoint x="530" y="187" />
        <di:waypoint x="590" y="187" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0th89ys_di" bpmnElement="Flow_0th89ys">
        <di:waypoint x="370" y="187" />
        <di:waypoint x="430" y="187" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1r3rcpi_di" bpmnElement="Flow_1r3rcpi">
        <di:waypoint x="215" y="187" />
        <di:waypoint x="270" y="187" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1vhnmwh_di" bpmnElement="Flow_1vhnmwh">
        <di:waypoint x="2640" y="187" />
        <di:waypoint x="2740" y="187" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_1">
        <dc:Bounds x="179" y="169" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1xjklk3_di" bpmnElement="Activity_0hi4moh">
        <dc:Bounds x="270" y="147" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1y2qrnh_di" bpmnElement="Activity_0t1oy8v">
        <dc:Bounds x="430" y="147" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1w59ou4_di" bpmnElement="Activity_11bwoyc">
        <dc:Bounds x="590" y="147" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0ferzkh_di" bpmnElement="Activity_0gup0i2">
        <dc:Bounds x="750" y="147" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1vtzdkg_di" bpmnElement="Activity_1xrl53c">
        <dc:Bounds x="910" y="147" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1encxis_di" bpmnElement="Activity_1hynd0y">
        <dc:Bounds x="1070" y="147" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0euuh51_di" bpmnElement="Activity_05x7br4">
        <dc:Bounds x="1230" y="147" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1gx23fj_di" bpmnElement="Activity_015hhqx">
        <dc:Bounds x="2740" y="147" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_092x1j8_di" bpmnElement="Activity_1ib3xgy" isExpanded="true">
        <dc:Bounds x="1410" y="82" width="540" height="210" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1gjhsst_di" bpmnElement="Flow_1gjhsst">
        <di:waypoint x="1800" y="170" />
        <di:waypoint x="1862" y="170" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0t65618_di" bpmnElement="Flow_0t65618">
        <di:waypoint x="1640" y="170" />
        <di:waypoint x="1700" y="170" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1e7cr15_di" bpmnElement="Flow_1e7cr15">
        <di:waypoint x="1488" y="170" />
        <di:waypoint x="1540" y="170" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="Event_1fh60qp_di" bpmnElement="Event_1fh60qp">
        <dc:Bounds x="1452" y="152" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_0utj1vy_di" bpmnElement="Event_0utj1vy">
        <dc:Bounds x="1862" y="152" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1odagkj_di" bpmnElement="Activity_00g7hqv">
        <dc:Bounds x="1540" y="130" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0pmslrf_di" bpmnElement="Activity_1fx4oho" bioc:stroke="#000000" bioc:fill="#ffffff" color:background-color="#ffffff" color:border-color="#000000">
        <dc:Bounds x="1700" y="130" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0dq3z5c_di" bpmnElement="Activity_0kwwiy2">
        <dc:Bounds x="2030" y="147" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1ulhfe9_di" bpmnElement="Activity_1qrx4i9" isExpanded="true">
        <dc:Bounds x="2230" y="82" width="410" height="210" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_152dq6y_di" bpmnElement="Flow_152dq6y">
        <di:waypoint x="2470" y="190" />
        <di:waypoint x="2542" y="190" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1py6j9x_di" bpmnElement="Flow_1py6j9x">
        <di:waypoint x="2298" y="190" />
        <di:waypoint x="2370" y="190" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNShape id="Event_1kldzbt_di" bpmnElement="Event_1kldzbt">
        <dc:Bounds x="2262" y="172" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_153g3c4_di" bpmnElement="Activity_1ihxtce">
        <dc:Bounds x="2370" y="150" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_11keq65_di" bpmnElement="Event_11keq65">
        <dc:Bounds x="2542" y="172" width="36" height="36" />
      </bpmndi:BPMNShape>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
